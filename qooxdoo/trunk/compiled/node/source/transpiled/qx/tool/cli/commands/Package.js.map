{
  "version": 3,
  "names": [
    "qx",
    "Bootstrap",
    "executePendingDefers",
    "$$dbClassInfo",
    "fs",
    "tool",
    "utils",
    "Promisify",
    "path",
    "require",
    "process",
    "stringify",
    "Class",
    "define",
    "extend",
    "cli",
    "commands",
    "Command",
    "statics",
    "cache_dir",
    "package_cache_name",
    "lockfile",
    "filename",
    "repository_cache_url",
    "getYargsCommand",
    "command",
    "desc",
    "builder",
    "yargs",
    "Cli",
    "addYargsCommands",
    "showHelpOnFail",
    "help",
    "members",
    "__cache",
    "checkMigrations",
    "getLockfilePath",
    "join",
    "cwd",
    "config",
    "Lockfile",
    "fileName",
    "deleteLockfile",
    "unlinkAsync",
    "getLockfileData",
    "getLockfileModel",
    "getData",
    "getInstance",
    "load",
    "getManifestModel",
    "Manifest",
    "_getConfigData",
    "_saveConfigData",
    "manifestModel",
    "lockfileModel",
    "argv",
    "save",
    "isDirty",
    "verbose",
    "compiler",
    "Console",
    "info",
    "getRelativeDataPath",
    "getInstalledLibraryTag",
    "repo_name",
    "library_name",
    "library",
    "getValue",
    "find",
    "lib",
    "repo_tag",
    "getInstalledLibraryData",
    "getCachePath",
    "ConfigDb",
    "getDirectory",
    "getRepositoryCacheUrl",
    "getCache",
    "readFromFile",
    "JSON",
    "parse",
    "readFileSync",
    "e",
    "repos",
    "list",
    "data",
    "compat",
    "setCache",
    "saveCache",
    "Utils",
    "makeParentDir",
    "writeFileAsync",
    "exportCache",
    "cache",
    "space",
    "error",
    "message",
    "exit",
    "clearCache",
    "unlinkSync",
    "Package"
  ],
  "sources": [
    "/home/andresf/workspace_qooxdoo/qooxdoo/qooxdoo-7.0/source/class/qx/tool/cli/commands/Package.js"
  ],
  "sourcesContent": [
    "/* ************************************************************************\n\n   qooxdoo - the new era of web development\n\n   http://qooxdoo.org\n\n   Copyright:\n     2017 Christian Boulanger\n\n   License:\n     MIT: https://opensource.org/licenses/MIT\n     See the LICENSE file in the project's top-level directory for details.\n\n   Authors:\n     * Christian Boulanger (info@bibliograph.org, @cboulanger)\n\n************************************************************************ */\nconst fs = qx.tool.utils.Promisify.fs;\nconst path = require(\"upath\");\nconst process = require(\"process\");\nconst stringify = require(\"json-stable-stringify\");\n\n/**\n * Handles library packages\n */\nqx.Class.define(\"qx.tool.cli.commands.Package\", {\n  extend: qx.tool.cli.commands.Command,\n\n  statics: {\n    /**\n     * The name of the directory in which to download the package files\n     */\n    cache_dir: \"qx_packages\",\n\n    /**\n     * The name of the file that caches the package registry\n     */\n    package_cache_name: \"package-cache.json\",\n\n    /**\n     * The lockfile with library versions etc.\n     */\n    lockfile: {\n      filename: \"qx-lock.json\"\n    },\n\n    /**\n     * The URL of the cached repository data\n     */\n    repository_cache_url:\n      \"https://raw.githubusercontent.com/qooxdoo/package-cache/master/cache.json\",\n\n    /**\n     * The yargs command data\n     * @return {{}}\n     */\n    getYargsCommand() {\n      return {\n        command: \"package <command> [options]\",\n        desc: \"manages qooxdoo packages\",\n        builder: yargs => {\n          qx.tool.cli.Cli.addYargsCommands(\n            yargs,\n            [\n              \"Install\",\n              \"List\",\n              \"Publish\",\n              \"Remove\",\n              \"Update\",\n              \"Upgrade\",\n              \"Migrate\"\n            ],\n\n            \"qx.tool.cli.commands.package\"\n          );\n\n          return yargs.showHelpOnFail().help();\n        }\n      };\n    }\n  },\n\n  members: {\n    /**\n     * The current cache object\n     */\n    __cache: null,\n\n    /**\n     * @override\n     */\n    async checkMigrations() {},\n\n    /**\n     * Returns the absolute path to the lockfile.\n     * @return {String}\n     */\n    getLockfilePath() {\n      return path.join(process.cwd(), qx.tool.config.Lockfile.config.fileName);\n    },\n\n    /**\n     * Deletes the lockfile\n     * @return {Promise<void>}\n     */\n    async deleteLockfile() {\n      await fs.unlinkAsync(this.getLockfilePath());\n    },\n\n    /**\n     * Returns the lockfile data. Deprecated. Use {@link qx.tool.cli.commands.Package#getLockfileModel}\n     * @deprecated\n     * @return {Object}\n     */\n    async getLockfileData() {\n      return (await this.getLockfileModel()).getData();\n    },\n\n    /**\n     * Returns the model of the lockfile\n     * @return {Promise<qx.tool.config.Lockfile>}\n     */\n    async getLockfileModel() {\n      return qx.tool.config.Lockfile.getInstance().load();\n    },\n\n    /**\n     * Returns the model of the manifest\n     * @return {Promise<qx.tool.config.Manifest>}\n     */\n    async getManifestModel() {\n      return qx.tool.config.Manifest.getInstance().load();\n    },\n\n    /**\n     * Convenience method to return all config file models as an array\n     * @return {Array} containing [{qx.tool.config.Manifest}, {qx.tool.config.Lockfile}, {qx.tool.config.Compile}]\n     */\n    async _getConfigData() {\n      return [await this.getManifestModel(), await this.getLockfileModel()];\n    },\n\n    /**\n     * Save configuration data if their content has changed\n     * @return {Promise<void>}\n     * @private\n     */\n    async _saveConfigData() {\n      const [manifestModel, lockfileModel] = await this._getConfigData();\n      if (this.argv.save && manifestModel.isDirty()) {\n        await manifestModel.save();\n        if (this.argv.verbose) {\n          qx.tool.compiler.Console.info(\n            `>>> Saved dependency data to ${manifestModel.getRelativeDataPath()}`\n          );\n        }\n      }\n      if (lockfileModel.isDirty()) {\n        await lockfileModel.save();\n        if (this.argv.verbose) {\n          qx.tool.compiler.Console.info(\n            `>>> Saved library data to ${lockfileModel.getRelativeDataPath()}`\n          );\n        }\n      }\n    },\n\n    /**\n     * Returns the tag name of the given library in the given package, if installed.\n     * Returns false if not installed.\n     * @param {String} repo_name\n     * @param {String} library_name\n     * @return {String|false}\n     */\n    async getInstalledLibraryTag(repo_name, library_name) {\n      let library = (await this.getLockfileModel())\n        .getValue(\"libraries\")\n        .find(\n          lib =>\n            lib.repo_name === repo_name && lib.library_name === library_name\n        );\n\n      return library ? library.repo_tag : false;\n    },\n\n    /**\n     * Returns the data of the given library, if installed.\n     * Returns false if not installed.\n     * @param {String} library_name\n     * @return {Object|false}\n     */\n    async getInstalledLibraryData(library_name) {\n      return (await this.getLockfileModel())\n        .getValue(\"libraries\")\n        .find(lib => lib.library_name === library_name);\n    },\n\n    /**\n     * Returns the absolute path to the file that persists the cache object\n     * @return {String}\n     */\n    getCachePath() {\n      return path.join(\n        qx.tool.cli.ConfigDb.getDirectory(),\n        this.self(arguments).package_cache_name\n      );\n    },\n\n    /**\n     * Returns the URL of the package registry data on GitHub\n     * @return {String}\n     */\n    getRepositoryCacheUrl() {\n      return this.self(arguments).repository_cache_url;\n    },\n\n    /**\n     * Returns the cache object, retrieving it from a local file if necessary\n     * @return {Object}\n     * @todo use config model API for cache file\n     */\n    getCache(readFromFile = false) {\n      if (!readFromFile && this.__cache && typeof this.__cache == \"object\") {\n        return this.__cache;\n      }\n      try {\n        this.__cache = JSON.parse(\n          fs.readFileSync(this.getCachePath(), \"UTF-8\")\n        );\n      } catch (e) {\n        this.__cache = {\n          repos: {\n            list: [],\n            data: {}\n          },\n\n          compat: {}\n        };\n      }\n      return this.__cache;\n    },\n\n    /**\n     * Manually overwrite the cache data\n     * @param data {Object}\n     * @return {void}\n     */\n    setCache(data) {\n      this.__cache = data;\n    },\n\n    /**\n     * Saves the cache to a hidden local file\n     * @return {void}\n     */\n    async saveCache() {\n      await qx.tool.utils.Utils.makeParentDir(this.getCachePath());\n      await fs.writeFileAsync(\n        this.getCachePath(),\n        JSON.stringify(this.__cache, null, 2),\n        \"UTF-8\"\n      );\n    },\n\n    /**\n     * Exports the cache to an external file. Note that the structure of the cache\n     * data can change any time. Do not build anything on it. You have been warned.\n     * @param path {String}\n     * @return {void}\n     */\n    async exportCache(path) {\n      try {\n        let cache = this.__cache || this.getCache(true);\n        let data = stringify(cache, { space: 2 });\n        await fs.writeFileAsync(path, data, \"UTF-8\");\n      } catch (e) {\n        qx.tool.compiler.Console.error(\n          `Error exporting cache to ${path}:` + e.message\n        );\n\n        process.exit(1);\n      }\n    },\n\n    /**\n     * Clears the cache\n     */\n    clearCache() {\n      this.__cache = null;\n      try {\n        fs.unlinkSync(this.getCachePath());\n      } catch (e) {}\n    }\n  }\n});\n"
  ],
  "mappings": "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"
}